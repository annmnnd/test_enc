
# hr_kpi_app.py
import pandas as pd
import numpy as np
import streamlit as st
import matplotlib.pyplot as plt
import seaborn as sns

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0) ê¸°ë³¸ ì„¤ì • (í˜ì´ì§€/í°íŠ¸/ìŠ¤íƒ€ì¼)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="í‡´ì§ìœ¨ KPI ì‹œê°í™”", layout="centered")
sns.set(style="whitegrid")

# í•œê¸€ í°íŠ¸ (ìœˆë„ìš°: ë§‘ì€ ê³ ë”•). ê·¸ë˜í”„ì—ì„œ í•œê¸€ì´ â–¡ë¡œ ê¹¨ì§ˆ ë•Œ ì‚¬ìš©.
try:
    plt.rcParams['font.family'] = "Malgun Gothic"
    plt.rcParams['axes.unicode_minus'] = False  # ë§ˆì´ë„ˆìŠ¤ ê¹¨ì§ ë°©ì§€
except Exception:
    pass

st.title("í‡´ì§ìœ¨ KPI ëŒ€ì‹œë³´ë“œ")
st.caption("ë§‰ëŒ€ê·¸ë˜í”„ / ë°•ìŠ¤í”Œë¡¯ / íˆíŠ¸ë§µ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_df(file) -> pd.DataFrame:
    if file is None:
        # ê¸°ë³¸ ê²½ë¡œ (ì›í•˜ë©´ íŒŒì¼ëª… ë°”ê¿”ë„ ë¨)
        return pd.read_csv("HR Data.csv", encoding="utf-8")
    return pd.read_csv(file, encoding="utf-8")

up = st.file_uploader("HR CSV ì—…ë¡œë“œ (.csv)", type=["csv"])
try:
    df = load_df(up)
except Exception as e:
    st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”: {e}")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ì „ì²˜ë¦¬: 'í‡´ì§' ìˆ«ìì—´ ë§Œë“¤ê¸°
#    - 'í‡´ì§ì—¬ë¶€'(Yes/No) ìˆìœ¼ë©´ 1/0ìœ¼ë¡œ ë§¤í•‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "í‡´ì§" not in df.columns:
    if "í‡´ì§ì—¬ë¶€" in df.columns:
        df["í‡´ì§"] = df["í‡´ì§ì—¬ë¶€"].map({"Yes": 1, "No": 0})
    else:
        st.error("'í‡´ì§' ë˜ëŠ” 'í‡´ì§ì—¬ë¶€' ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        st.stop()

# ìˆ«ìí˜• ê°•ì œ
df["í‡´ì§"] = pd.to_numeric(df["í‡´ì§"], errors="coerce")

# ì‚¬ì´ë“œë°” ì˜µì…˜
with st.sidebar:
    show_heat = st.checkbox("íˆíŠ¸ë§µ(ìƒê´€ê´€ê³„) ë³´ê¸°", value=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) KPI #1: ì—…ë¬´í™˜ê²½ë§Œì¡±ë„ â†’ í‡´ì§ìœ¨ (ë§‰ëŒ€ê·¸ë˜í”„)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ˜€ KPI #1 â€” ì—…ë¬´í™˜ê²½ë§Œì¡±ë„ ëŒ€ë¹„ í‡´ì§ìœ¨ (ë§‰ëŒ€ê·¸ë˜í”„)")

if "ì—…ë¬´í™˜ê²½ë§Œì¡±ë„" in df.columns:
    df["ì—…ë¬´í™˜ê²½ë§Œì¡±ë„"] = pd.to_numeric(df["ì—…ë¬´í™˜ê²½ë§Œì¡±ë„"], errors="coerce")
    d1 = df[["ì—…ë¬´í™˜ê²½ë§Œì¡±ë„", "í‡´ì§"]].dropna()

    if d1.empty:
        st.warning("ì—…ë¬´í™˜ê²½ë§Œì¡±ë„/í‡´ì§ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
    else:
        g1 = (
            d1.groupby("ì—…ë¬´í™˜ê²½ë§Œì¡±ë„")["í‡´ì§"]
              .mean()
              .reset_index()
              .rename(columns={"í‡´ì§": "rate"})
              .sort_values("ì—…ë¬´í™˜ê²½ë§Œì¡±ë„")
        )
        g1["pct"] = (g1["rate"] * 100).round(1)

        fig1, ax1 = plt.subplots(figsize=(7.5, 3.8))
        sns.barplot(data=g1, x="ì—…ë¬´í™˜ê²½ë§Œì¡±ë„", y="pct", ax=ax1)
        ax1.set_xlabel("ì—…ë¬´í™˜ê²½ë§Œì¡±ë„")
        ax1.set_ylabel("í‡´ì§ìœ¨(%)")
        ax1.set_title("ë§Œì¡±ë„ë³„ í‡´ì§ìœ¨(%)")
        # ë§‰ëŒ€ ë¼ë²¨
        for p in ax1.patches:
            height = p.get_height()
            ax1.annotate(f"{height:.1f}%", (p.get_x() + p.get_width()/2, height),
                         ha='center', va='bottom', fontsize=9, xytext=(0, 2), textcoords='offset points')
        st.pyplot(fig1, clear_figure=True)
else:
    st.info("ì»¬ëŸ¼ 'ì—…ë¬´í™˜ê²½ë§Œì¡±ë„'ê°€ ì—†ìŠµë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) KPI #2: ê·¼ì†ì—°ìˆ˜ â†’ í‡´ì§ (ë°•ìŠ¤í”Œë¡¯)
#     - xì¶•: í‡´ì§(0=ì¬ì§, 1=í‡´ì§)
#     - yì¶•: ê·¼ì†ì—°ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“ˆ KPI #2 â€” ê·¼ì†ì—°ìˆ˜ ë¶„í¬ (í‡´ì§ vs ì¬ì§, ë°•ìŠ¤í”Œë¡¯)")

if "ê·¼ì†ì—°ìˆ˜" in df.columns:
    df["ê·¼ì†ì—°ìˆ˜"] = pd.to_numeric(df["ê·¼ì†ì—°ìˆ˜"], errors="coerce")
    d2 = df[["ê·¼ì†ì—°ìˆ˜", "í‡´ì§"]].dropna()

    if d2.empty:
        st.warning("ê·¼ì†ì—°ìˆ˜/í‡´ì§ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
    else:
        fig2, ax2 = plt.subplots(figsize=(7.5, 3.8))
        sns.boxplot(data=d2, x="í‡´ì§", y="ê·¼ì†ì—°ìˆ˜", ax=ax2)
        ax2.set_xlabel("í‡´ì§(0=ì¬ì§, 1=í‡´ì§)")
        ax2.set_ylabel("ê·¼ì†ì—°ìˆ˜(ë…„)")
        ax2.set_title("í‡´ì§ì—¬ë¶€ë³„ ê·¼ì†ì—°ìˆ˜ ë¶„í¬ (Boxplot)")
        st.pyplot(fig2, clear_figure=True)
else:
    st.info("ì»¬ëŸ¼ 'ê·¼ì†ì—°ìˆ˜'ê°€ ì—†ìŠµë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) KPI #3: ì „ê³µ â†’ í‡´ì§ìœ¨ (ê°€ë¡œ ë§‰ëŒ€ê·¸ë˜í”„, ìƒìœ„ Nê°œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("ğŸ“ KPI #3 â€” ì „ê³µë³„ í‡´ì§ìœ¨ (ê°€ë¡œ ë§‰ëŒ€ê·¸ë˜í”„)")

if "ì „ê³µ" in df.columns:
    d3 = df[["ì „ê³µ", "í‡´ì§"]].dropna()
    if d3.empty:
        st.warning("ì „ê³µ/í‡´ì§ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
    else:
        g3 = (
            d3.groupby("ì „ê³µ")["í‡´ì§"]
              .mean()
              .reset_index()
              .rename(columns={"í‡´ì§": "rate"})
        )
        g3["pct"] = (g3["rate"] * 100).round(1)
        g3 = g3.sort_values("pct", ascending=False).head(20)

        fig3, ax3 = plt.subplots(figsize=(8.5, max(3.5, 0.35*len(g3))))
        sns.barplot(data=g3, y="ì „ê³µ", x="pct", ax=ax3)
        ax3.set_xlabel("í‡´ì§ìœ¨(%)")
        ax3.set_ylabel("ì „ê³µ")
        ax3.set_title(f"ì „ê³µë³„ í‡´ì§ìœ¨ ìƒìœ„ {len(g3)}ê°œ")
        # ë¼ë²¨
        for p in ax3.patches:
            width = p.get_width()
            y = p.get_y() + p.get_height()/2
            ax3.annotate(f"{width:.1f}%", (width, y),
                         ha='left', va='center', fontsize=9, xytext=(3, 0), textcoords='offset points')
        st.pyplot(fig3, clear_figure=True)
else:
    st.info("ì»¬ëŸ¼ 'ì „ê³µ'ì´ ì—†ìŠµë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) (ì„ íƒ) íˆíŠ¸ë§µ: ìˆ˜ì¹˜í˜• ë³€ìˆ˜ â†” í‡´ì§ ìƒê´€ê´€ê³„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if show_heat:
    st.subheader("ğŸ§ª ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ â€” ìˆ˜ì¹˜í˜• ë³€ìˆ˜ vs í‡´ì§")
    # ìˆ˜ì¹˜í˜•ë§Œ ì¶”ì¶œ
    num_cols = df.select_dtypes(include=[np.number]).columns.tolist()
    # ë„ˆë¬´ ë§ìœ¼ë©´ í•µì‹¬ í›„ë³´ë§Œ ë‚¨ê¸°ê¸° (ìˆì„ ë•Œë§Œ)
    prefer = ["í‡´ì§", "ì—…ë¬´í™˜ê²½ë§Œì¡±ë„", "ê·¼ì†ì—°ìˆ˜", "ê¸‰ì—¬ì¦ê°€ë¶„ë°±ë¶„ìœ¨", "ìŠ¤í†¡ì˜µì…˜ì •ë„", "ì§‘ê³¼ì˜ê±°ë¦¬", "í˜„ì¬ì—­í• ë…„ìˆ˜", "ë§ˆì§€ë§‰ìŠ¹ì§„ë…„ìˆ˜"]
    cols = [c for c in prefer if c in num_cols]
    if len(cols) < 2:
        cols = num_cols[:8]  # ìµœì†Œ êµ¬ì„±
    use = df[cols].dropna()
    if use.empty:
        st.info("íˆíŠ¸ë§µì„ ê·¸ë¦´ ìˆ˜ì¹˜í˜• ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")
    else:
        corr = use.corr(numeric_only=True)
        fig4, ax4 = plt.subplots(figsize=(1.2*len(cols), 0.9*len(cols)))
        sns.heatmap(corr, annot=True, fmt=".2f", cmap="RdBu_r", center=0, ax=ax4)
        ax4.set_title("ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ (ìˆ˜ì¹˜í˜• ë³€ìˆ˜)")
        st.pyplot(fig4, clear_figure=True)


